#!/usr/bin/env python3
"""
Aplicaci√≥n Streamlit Principal - Conciliador Bancario
Interfaz de usuario profesional para conciliaci√≥n bancaria
"""

import streamlit as st
import logging
from typing import Dict, Any, Optional
from pathlib import Path

# Importaciones internas
from config.settings import load_config, validate_config
from services.google_sheets import GoogleSheetsService
from core.processor import BankProcessor
from ui.components import UIComponents
from utils.helpers import setup_logging

logger = logging.getLogger(__name__)

class ConciliadorApp:
    """Aplicaci√≥n principal del Conciliador Bancario"""
    
    def __init__(self):
        """Inicializar la aplicaci√≥n"""
        self.config = load_config()
        self.ui_components = UIComponents()
        self.processor = BankProcessor()
        self.sheets_service: Optional[GoogleSheetsService] = None
        
        # Validar configuraci√≥n
        config_errors = validate_config(self.config)
        if config_errors:
            logger.warning(f"Errores de configuraci√≥n: {config_errors}")
        
        self._setup_page_config()
        self._setup_session_state()
    
    def _setup_page_config(self):
        """Configurar la p√°gina de Streamlit"""
        st.set_page_config(
            page_title="üè¶ Conciliador Bancario Pro",
            page_icon="üè¶",
            layout="wide",
            initial_sidebar_state="expanded",
            menu_items={
                'Get Help': 'https://github.com/tu-repo/conciliador',
                'Report a bug': 'https://github.com/tu-repo/conciliador/issues',
                'About': "Conciliador Bancario Profesional v2.0"
            }
        )
    
    def _setup_session_state(self):
        """Configurar el estado de la sesi√≥n"""
        if "app_state" not in st.session_state:
            st.session_state.app_state = {
                "current_step": 0,
                "processed_files": [],
                "processing_stats": {},
                "google_sheets_ready": False,
                "upload_completed": False,
                "config_validated": False
            }
    
    def _setup_sidebar(self) -> Dict[str, Any]:
        """Configurar el sidebar con opciones"""
        with st.sidebar:
            self.ui_components.render_sidebar_header()
            
            # Configuraci√≥n de Google Sheets
            sheet_config = self._render_sheets_config()
            
            # Modo Demo
            demo_mode = self._render_demo_mode()
            
            # Estado de conexi√≥n
            connection_status = self._render_connection_status(sheet_config)
            
            # Estad√≠sticas de sesi√≥n
            self._render_session_stats()
            
            return {
                "sheet_id": sheet_config["sheet_id"],
                "sheet_tab": sheet_config["sheet_tab"],
                "demo_mode": demo_mode,
                "connection_status": connection_status
            }
    
    def _render_sheets_config(self) -> Dict[str, str]:
        """Renderizar configuraci√≥n de Google Sheets"""
        st.markdown("#### üìä Google Sheets")
        
        sheet_id = st.text_input(
            "ID de la Hoja", 
            value=self.config.get("SHEET_ID", ""),
            placeholder="1BvyC2y3nRhCvKa9Q8yX7zF...",
            help="El ID de tu hoja de Google Sheets"
        )
        
        sheet_tab = st.text_input(
            "Nombre de la Pesta√±a",
            value=self.config.get("SHEET_TAB", "Movimientos_Nuevos"),
            placeholder="Movimientos_Nuevos",
            help="Nombre de la pesta√±a donde se insertar√°n los datos"
        )
        
        return {"sheet_id": sheet_id, "sheet_tab": sheet_tab}
    
    def _render_demo_mode(self) -> bool:
        """Renderizar modo demo"""
        st.markdown("---")
        st.markdown("#### üß™ Modo Demo")
        
        demo_mode = st.toggle(
            "üöÄ Activar Modo Demo", 
            help="Saltar√° verificaciones de duplicados para testing",
            key="demo_mode"
        )
        
        if demo_mode:
            st.info("üéØ Modo Demo Activo - Sin verificaci√≥n de duplicados")
            os.environ["DEMO_MODE"] = "true"
        else:
            os.environ.pop("DEMO_MODE", None)
        
        return demo_mode
    
    def _render_connection_status(self, sheet_config: Dict[str, str]) -> bool:
        """Renderizar estado de conexi√≥n"""
        st.markdown("---")
        st.markdown("#### üîó Estado de Conexi√≥n")
        
        sheet_id = sheet_config["sheet_id"]
        
        if sheet_id and sheet_id != "TU_SHEET_ID":
            try:
                self.sheets_service = GoogleSheetsService(sheet_id)
                st.success("‚úÖ Conexi√≥n establecida")
                st.session_state.app_state["google_sheets_ready"] = True
                st.info(f"üìÑ Pesta√±a: `{sheet_config['sheet_tab']}`")
                return True
            except Exception as e:
                st.error("‚ùå Error de conexi√≥n")
                st.session_state.app_state["google_sheets_ready"] = False
                self.ui_components.show_warning_card(
                    "Problema de Configuraci√≥n",
                    f"No se pudo conectar: {str(e)[:100]}...",
                    "Verifica tu configuraci√≥n de Google Sheets"
                )
                return False
        else:
            st.warning("‚ö†Ô∏è Modo de prueba")
            st.session_state.app_state["google_sheets_ready"] = False
            self.ui_components.show_info_card(
                "Modo de Prueba Activo",
                "Configura Google Sheets para funcionalidad completa"
            )
            return False
    
    def _render_session_stats(self):
        """Renderizar estad√≠sticas de sesi√≥n"""
        st.markdown("---")
        st.markdown("#### üìà Estad√≠sticas de Sesi√≥n")
        
        if st.session_state.app_state["processed_files"]:
            total_files = len(st.session_state.app_state["processed_files"])
            total_records = sum([
                f.get("total_records", 0) 
                for f in st.session_state.app_state["processed_files"]
            ])
            
            st.metric("Archivos Procesados", total_files)
            st.metric("Registros Totales", total_records)
        else:
            st.info("Sin archivos procesados a√∫n")
    
    def _render_file_upload_tab(self, sidebar_config: Dict[str, Any]):
        """Renderizar pesta√±a de carga de archivos"""
        st.markdown("## üìÅ Carga de Archivos Bancarios")
        
        self.ui_components.render_file_upload_zone()
        
        col1, col2 = st.columns([3, 1])
        
        with col1:
            uploaded_files = st.file_uploader(
                "Selecciona archivos bancarios",
                accept_multiple_files=True,
                type=['txt', 'csv'],
                help="Puedes cargar m√∫ltiples archivos a la vez",
                label_visibility="collapsed"
            )
        
        with col2:
            self.ui_components.render_upload_tips()
        
        if uploaded_files:
            if st.button("üîç Analizar Archivos", type="primary", use_container_width=True):
                with st.spinner("Iniciando an√°lisis..."):
                    try:
                        results = self.processor.process_files(
                            uploaded_files, 
                            sidebar_config["sheet_id"], 
                            sidebar_config["sheet_tab"],
                            sidebar_config["demo_mode"]
                        )
                        
                        if results:
                            st.session_state["processing_results"] = results
                            st.session_state.app_state["current_step"] = 1
                            st.rerun()
                    except Exception as e:
                        st.error(f"Error procesando archivos: {e}")
                        logger.error(f"Error en procesamiento: {e}")
        
        return uploaded_files
    
    def _render_processing_tab(self):
        """Renderizar pesta√±a de procesamiento"""
        if "processing_results" not in st.session_state:
            self.ui_components.show_info_card(
                "Sin Datos Procesados",
                "Primero carga y procesa algunos archivos en la pesta√±a anterior",
                "üìÅ"
            )
            return
        
        results = st.session_state["processing_results"]
        
        st.markdown("## üìã Resultados del Procesamiento")
        
        for result in results:
            with st.expander(f"üìÑ {result['file_name']} - {len(result['new_data'])} registros nuevos"):
                col1, col2 = st.columns(2)
                
                with col1:
                    st.metric("Total Le√≠dos", result["stats"]["FilasLe√≠das"])
                    st.metric("Duplicados", result["stats"]["DuplicadosSaltados"])
                
                with col2:
                    st.metric("Nuevos", result["stats"]["NuevosInsertados"])
                    st.metric("Conflictos", result["stats"]["Conflictivos"])
                
                if not result["new_data"].empty:
                    st.markdown("**Vista previa de datos nuevos:**")
                    st.dataframe(result["new_data"].head(), use_container_width=True)
        
        # Bot√≥n para proceder a inserci√≥n
        total_new = sum([len(r["new_data"]) for r in results])
        if total_new > 0:
            if st.button(f"‚û°Ô∏è Proceder a Inserci√≥n ({total_new} registros)", 
                       type="primary", use_container_width=True):
                st.session_state.app_state["current_step"] = 2
                st.rerun()
    
    def _render_insertion_tab(self, sidebar_config: Dict[str, Any]):
        """Renderizar pesta√±a de inserci√≥n"""
        if "processing_results" not in st.session_state:
            self.ui_components.show_info_card(
                "Sin Datos para Insertar",
                "Primero procesa algunos archivos en las pesta√±as anteriores",
                "üîç"
            )
            return
        
        results = st.session_state["processing_results"]
        total_new = sum([len(r["new_data"]) for r in results])
        
        if total_new == 0:
            self.ui_components.show_info_card(
                "Sin Datos para Insertar",
                "Todos los registros ya existen en tu hoja de Google Sheets",
                "üîÑ"
            )
            return
        
        st.markdown("## üìä Inserci√≥n a Google Sheets")
        
        # Resumen de inserci√≥n
        col1, col2 = st.columns(2)
        
        with col1:
            self.ui_components.render_insertion_summary(total_new, len(results))
        
        with col2:
            self.ui_components.render_time_estimation(total_new)
        
        # Bot√≥n de inserci√≥n
        st.markdown("<br>", unsafe_allow_html=True)
        
        if st.button(f"üöÄ Insertar {total_new} Registros a Google Sheets", 
                     type="primary", use_container_width=True):
            
            try:
                if self.sheets_service:
                    self.sheets_service.insert_results(results, sidebar_config["sheet_tab"])
                    st.success("‚úÖ Inserci√≥n completada exitosamente")
                    st.balloons()
                else:
                    st.warning("‚ö†Ô∏è Modo demo - No se realiz√≥ inserci√≥n real")
                    
            except Exception as e:
                st.error(f"‚ùå Error durante la inserci√≥n: {e}")
                logger.error(f"Error en inserci√≥n: {e}")
    
    def run(self):
        """Ejecutar la aplicaci√≥n principal"""
        try:
            # Configurar sidebar
            sidebar_config = self._setup_sidebar()
            
            # Renderizar header principal
            self.ui_components.render_main_header()
            
            # Navegaci√≥n por pesta√±as
            tabs = ["üìÅ Cargar Archivos", "üîç Procesar Datos", "üìä Insertar a Sheets"]
            tab1, tab2, tab3 = st.tabs(tabs)
            
            with tab1:
                self._render_file_upload_tab(sidebar_config)
            
            with tab2:
                self._render_processing_tab()
            
            with tab3:
                self._render_insertion_tab(sidebar_config)
                
        except Exception as e:
            logger.error(f"Error en la aplicaci√≥n: {e}")
            st.error(f"Error fatal: {e}")

def run_app():
    """Funci√≥n principal para ejecutar la aplicaci√≥n"""
    # Crear directorio de logs si no existe
    Path("logs").mkdir(exist_ok=True)
    
    # Configurar logging
    setup_logging()
    
    # Crear y ejecutar la aplicaci√≥n
    app = ConciliadorApp()
    app.run()

if __name__ == "__main__":
    run_app()

